name: App.py CI/CD Pipeline with Eval & Red Team

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'agenticai.py'
      - 'utils.py'
      - '.github/workflows/app-cicd-pipeline.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'agenticai.py'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'uat'
        type: choice
        options:
          - uat
          - production

env:
  PYTHON_VERSION: '3.12'
  AZURE_WEBAPP_NAME_UAT: 'agenticai-app-uat'
  AZURE_WEBAPP_NAME_PROD: 'agenticai-app-prod'

permissions:
  contents: read
  id-token: write

jobs:
  # ==================== TESTING STAGE ====================
  quality-gates:
    name: Quality Gates - Eval & Red Team
    runs-on: ubuntu-latest
    environment: testing
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Create virtual environment
        run: |
          python -m venv venv
          source venv/bin/activate
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure Azure credentials
        env:
          PROJECT_ENDPOINT: ${{ secrets.PROJECT_ENDPOINT }}
          MODEL_ENDPOINT: ${{ secrets.MODEL_ENDPOINT }}
          MODEL_API_KEY: ${{ secrets.MODEL_API_KEY }}
          MODEL_DEPLOYMENT_NAME: ${{ secrets.MODEL_DEPLOYMENT_NAME }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          AZURE_API_VERSION: ${{ secrets.AZURE_API_VERSION }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          AZURE_PROJECT_NAME: ${{ secrets.AZURE_PROJECT_NAME }}
          AZURE_AI_PROJECT: ${{ secrets.AZURE_AI_PROJECT }}
          APPLICATION_INSIGHTS_CONNECTION_STRING: ${{ secrets.APPLICATION_INSIGHTS_CONNECTION_STRING }}
        run: |
          echo "Azure credentials configured"
          
      - name: Run Evaluation Tests
        id: eval
        continue-on-error: false
        env:
          PROJECT_ENDPOINT: ${{ secrets.PROJECT_ENDPOINT }}
          MODEL_ENDPOINT: ${{ secrets.MODEL_ENDPOINT }}
          MODEL_API_KEY: ${{ secrets.MODEL_API_KEY }}
          MODEL_DEPLOYMENT_NAME: ${{ secrets.MODEL_DEPLOYMENT_NAME }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          AZURE_API_VERSION: ${{ secrets.AZURE_API_VERSION }}
          APPLICATION_INSIGHTS_CONNECTION_STRING: ${{ secrets.APPLICATION_INSIGHTS_CONNECTION_STRING }}
          AZURE_TRACING_GEN_AI_CONTENT_RECORDING_ENABLED: "true"
        run: |
          echo "Running evaluation tests..."
          python -c "from agenticai import eval; result = eval(); print(result); exit(0 if result else 1)"
          echo "âœ… Evaluation tests passed"

      - name: Run Red Team Security Tests
        id: redteam
        continue-on-error: false
        env:
          PROJECT_ENDPOINT: ${{ secrets.PROJECT_ENDPOINT }}
          MODEL_ENDPOINT: ${{ secrets.MODEL_ENDPOINT }}
          MODEL_API_KEY: ${{ secrets.MODEL_API_KEY }}
          MODEL_DEPLOYMENT_NAME: ${{ secrets.MODEL_DEPLOYMENT_NAME }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_ENDPOINT_REDTEAM: ${{ secrets.AZURE_OPENAI_ENDPOINT_REDTEAM }}
          AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          AZURE_API_VERSION: ${{ secrets.AZURE_API_VERSION }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          AZURE_PROJECT_NAME: ${{ secrets.AZURE_PROJECT_NAME }}
          AZURE_AI_PROJECT: ${{ secrets.AZURE_AI_PROJECT }}
          APPLICATION_INSIGHTS_CONNECTION_STRING: ${{ secrets.APPLICATION_INSIGHTS_CONNECTION_STRING }}
          AZURE_TRACING_GEN_AI_CONTENT_RECORDING_ENABLED: "true"
        run: |
          echo "Running Red Team security tests..."
          python -c "import asyncio; from agenticai import redteam; result = asyncio.run(redteam()); print(result); exit(0 if result else 1)"
          echo "âœ… Red Team tests passed"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            *.json
            *.log
          retention-days: 30

      - name: Quality Gate Summary
        if: success()
        run: |
          echo "ğŸ‰ All quality gates passed!"
          echo "âœ… Evaluation: PASSED"
          echo "âœ… Red Team: PASSED"

  # ==================== BUILD STAGE ====================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: quality-gates
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Create virtual environment and install dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Verify app.py exists
        run: |
          if [ ! -f "app.py" ]; then
            echo "âŒ app.py not found!"
            exit 1
          fi
          echo "âœ… app.py found"

      - name: Create startup script for Streamlit
        run: |
          cat > startup.sh << 'EOF'
          #!/bin/bash
          echo "Starting Streamlit application..."
          python -m streamlit run app.py --server.port=8000 --server.address=0.0.0.0 --server.enableCORS=false --server.enableXsrfProtection=false
          EOF
          chmod +x startup.sh

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: |
            app.py
            agenticai.py
            utils.py
            user_logic_apps.py
            requirements.txt
            startup.sh
            data/
            img/
            !venv/
            !__pycache__/
            !*.pyc

  # ==================== UAT DEPLOYMENT ====================
  deploy-uat:
    name: Deploy to UAT
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'uat')
    environment:
      name: 'UAT'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app
          path: .

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_UAT }}

      - name: Deploy to Azure Web App (UAT)
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME_UAT }}
          slot-name: 'production'
          startup-command: 'bash startup.sh'

      - name: Configure App Settings (UAT)
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME_UAT }}
          app-settings-json: |
            [
              {
                "name": "PROJECT_ENDPOINT",
                "value": "${{ secrets.PROJECT_ENDPOINT_UAT }}",
                "slotSetting": false
              },
              {
                "name": "MODEL_ENDPOINT",
                "value": "${{ secrets.MODEL_ENDPOINT_UAT }}",
                "slotSetting": false
              },
              {
                "name": "MODEL_API_KEY",
                "value": "${{ secrets.MODEL_API_KEY_UAT }}",
                "slotSetting": false
              },
              {
                "name": "MODEL_DEPLOYMENT_NAME",
                "value": "${{ secrets.MODEL_DEPLOYMENT_NAME_UAT }}",
                "slotSetting": false
              },
              {
                "name": "AZURE_OPENAI_ENDPOINT",
                "value": "${{ secrets.AZURE_OPENAI_ENDPOINT_UAT }}",
                "slotSetting": false
              },
              {
                "name": "AZURE_OPENAI_KEY",
                "value": "${{ secrets.AZURE_OPENAI_KEY_UAT }}",
                "slotSetting": false
              },
              {
                "name": "APPLICATION_INSIGHTS_CONNECTION_STRING",
                "value": "${{ secrets.APPLICATION_INSIGHTS_CONNECTION_STRING_UAT }}",
                "slotSetting": false
              },
              {
                "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                "value": "true",
                "slotSetting": false
              }
            ]

      - name: Health Check (UAT)
        run: |
          echo "Waiting for UAT deployment to stabilize..."
          sleep 30
          echo "âœ… UAT deployment complete"

  # ==================== PRODUCTION DEPLOYMENT ====================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, deploy-uat]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app
          path: .

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Deploy to Azure Web App (Production)
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME_PROD }}
          slot-name: 'production'
          startup-command: 'bash startup.sh'

      - name: Configure App Settings (Production)
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME_PROD }}
          app-settings-json: |
            [
              {
                "name": "PROJECT_ENDPOINT",
                "value": "${{ secrets.PROJECT_ENDPOINT_PROD }}",
                "slotSetting": false
              },
              {
                "name": "MODEL_ENDPOINT",
                "value": "${{ secrets.MODEL_ENDPOINT_PROD }}",
                "slotSetting": false
              },
              {
                "name": "MODEL_API_KEY",
                "value": "${{ secrets.MODEL_API_KEY_PROD }}",
                "slotSetting": false
              },
              {
                "name": "MODEL_DEPLOYMENT_NAME",
                "value": "${{ secrets.MODEL_DEPLOYMENT_NAME_PROD }}",
                "slotSetting": false
              },
              {
                "name": "AZURE_OPENAI_ENDPOINT",
                "value": "${{ secrets.AZURE_OPENAI_ENDPOINT_PROD }}",
                "slotSetting": false
              },
              {
                "name": "AZURE_OPENAI_KEY",
                "value": "${{ secrets.AZURE_OPENAI_KEY_PROD }}",
                "slotSetting": false
              },
              {
                "name": "APPLICATION_INSIGHTS_CONNECTION_STRING",
                "value": "${{ secrets.APPLICATION_INSIGHTS_CONNECTION_STRING_PROD }}",
                "slotSetting": false
              },
              {
                "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                "value": "true",
                "slotSetting": false
              }
            ]

      - name: Health Check (Production)
        run: |
          echo "Waiting for Production deployment to stabilize..."
          sleep 30
          echo "âœ… Production deployment complete"

      - name: Deployment Summary
        run: |
          echo "ğŸš€ Deployment Summary"
          echo "===================="
          echo "Application: app.py (Streamlit)"
          echo "Environment: Production"
          echo "Status: âœ… DEPLOYED"
          echo "URL: https://${{ env.AZURE_WEBAPP_NAME_PROD }}.azurewebsites.net"

  # ==================== NOTIFICATION ====================
  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "âœ… Deployment succeeded"
          else
            echo "âŒ Deployment failed"
            exit 1
          fi
